{"version":3,"file":"check_status.min.js","sources":["../src/check_status.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module check_status\n *\n * @module     paygw_fawry/check_status\n * @copyright  2024 Mohammad Farouk <phun.for.physics@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Ajax from 'core/ajax';\nimport $ from 'jquery';\nimport * as reportSelectors from 'core_reportbuilder/local/selectors';\n\nlet successUrl;\nlet disabledTimeout;\n\nconst Selectors = {\n    bulkCheck: 'button[data-action=\"check-status-bulk\"]',\n    reportWrapper: '[data-region=\"fawry-report-wrapper\"]',\n    checkbox: 'input[type=\"checkbox\"][data-togglegroup=\"report-select-all\"][data-toggle=\"slave\"]',\n    masterCheckbox: 'input[type=\"checkbox\"][data-togglegroup=\"report-select-all\"][data-toggle=\"master\"]',\n    checkedRows: '[data-togglegroup=\"report-select-all\"][data-toggle=\"slave\"]:checked',\n};\n\n/**\n * Check the order status\n * @param {Number} orderId\n * @returns {Promise<Object>}\n */\nfunction checkStatus(orderId) {\n    let request = Ajax.call([{\n        methodname: 'paygw_fawry_check_status',\n        args: {\n            orderid: orderId\n        }\n    }]);\n    return request[0];\n}\n\n/**\n * Instant check for the order status.\n * @param {Array<Number>|Number} orderIds\n * @returns {Promise<Object>}\n */\nasync function instantCheck(orderIds) {\n    let ids = Array.isArray(orderIds) ? orderIds : [orderIds];\n    let tobeRequested = ids.map(orderId => {\n        return {\n            methodname: 'paygw_fawry_instant_check',\n            args: {\n                orderid: orderId\n            }\n        };\n    });\n    let requests = Ajax.call(tobeRequested);\n    let data = await Promise.all(requests);\n\n    let indexedData = {};\n    data.forEach((response, index) => {\n        indexedData[ids[index]] = response;\n    });\n\n    // eslint-disable-next-line no-console\n    console.log(await indexedData);\n    return indexedData;\n}\n/**\n * Perform instance check for a specific order id.\n * @param {Number|Array<number>} orderIds\n */\nasync function instanceCheckForIds(orderIds) {\n    orderIds = Array.isArray(orderIds) ? orderIds : [orderIds];\n    let holders = {};\n    for (const orderId of orderIds) {\n        holders[orderId] = $('[data-purpose=\"status-response\"][data-orderid=\"' + orderId + '\"]');\n        holders[orderId].html('Checking...');\n    }\n\n    let response = await instantCheck(orderIds);\n\n    for (const orderId of orderIds) {\n        let $this = $('[data-action=\"check-status\"][data-orderid=\"' + orderId + '\"]').filter('a, button');\n        let statusCell = $this.closest('tr').find('[data-purpose=\"order-status\"]');\n        if (response[orderId].status) {\n            statusCell.text(response[orderId].status);\n        }\n\n        if (response[orderId].msg) {\n            let responseHtml = \"<br><pre>\" + JSON.stringify(response[orderId], null, '\\t') + \"</pre>\";\n            if (holders[orderId].length) {\n                holders[orderId].html(responseHtml);\n            } else if (statusCell.length) {\n                let newHolder = $('<div data-purpose=\"status-response\" data-orderid=\"' + orderId + '\"></div>');\n                statusCell.append(newHolder);\n                newHolder.html(responseHtml);\n                setTimeout(function() {\n                    newHolder.fadeOut(500, function() {\n                        $(this).remove();\n                    });\n                }, 15000);\n            }\n        }\n    }\n}\n/**\n * Register the instance check button in the reports table.\n */\nasync function registerInstanceCheckButton() {\n    let button = $('button[data-action=\"check-status\"], a[data-action=\"check-status\"]');\n    button.on('click', async function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        let $this = $(this); // Save reference to button\n        clearTimeout(disabledTimeout);\n        $this.attr('disabled', true);\n\n        let orderId = $this.data(\"orderid\");\n        if (orderId) {\n            await instanceCheckForIds(orderId);\n        }\n\n        disabledTimeout = setTimeout(function() {\n            $this.attr('disabled', false);\n        }, 5000);\n    });\n\n    let bulkButton = $(Selectors.bulkCheck);\n    bulkButton.on('click', async function(e) {\n        e.preventDefault();\n        e.stopPropagation();\n        let $this = $(this); // Save reference to button\n        clearTimeout(disabledTimeout);\n        $this.attr('disabled', true);\n\n        let reportRegion = $(reportSelectors.regions.report);\n        const selectedOrders = [...reportRegion.find(Selectors.checkedRows)];\n        const ordersIds = selectedOrders.map(check => parseInt(check.value));\n        await instanceCheckForIds(ordersIds);\n\n        disabledTimeout = setTimeout(function() {\n            $this.attr('disabled', false);\n        }, 5000);\n    });\n}\n/**\n * Register the check button in process page.\n * @param {Number} orderid\n */\nasync function registerNormalCheckButton(orderid) {\n    let button = $('button[data-action=\"check-status\"]');\n    button.on('click', async function() {\n        let $this = $(this); // Save reference to button\n\n        if (orderid) {\n            clearTimeout(disabledTimeout);\n            $this.attr('disabled', true);\n            await instantCheck(orderid);\n            let response = await checkStatus(orderid);\n            if (response.status === 'success') {\n                window.location.href = successUrl;\n            } else {\n                disabledTimeout = setTimeout(function() {\n                    $this.attr('disabled', false);\n                }, 30000);\n            }\n        }\n    });\n}\n\nexport const init = (orderid = null, url = null) => {\n\n    if (orderid) {\n        successUrl = url;\n        var interval = setInterval(async function() {\n            let response = await checkStatus(orderid);\n            if (response.status === 'success') {\n                clearInterval(interval);\n                window.location.href = successUrl;\n            } else if (response.status === 'failed') {\n                clearInterval(interval);\n            }\n            $('[data-purpose=\"status\"]').text(response.status);\n        }, 15000);\n    }\n\n    if (orderid) {\n        registerNormalCheckButton();\n    } else {\n        registerInstanceCheckButton();\n    }\n\n};"],"names":["successUrl","disabledTimeout","Selectors","checkStatus","orderId","Ajax","call","methodname","args","orderid","instantCheck","orderIds","ids","Array","isArray","tobeRequested","map","requests","data","Promise","all","indexedData","forEach","response","index","console","log","instanceCheckForIds","holders","html","statusCell","filter","closest","find","status","text","msg","responseHtml","JSON","stringify","length","newHolder","append","setTimeout","fadeOut","this","remove","registerInstanceCheckButton","on","async","e","preventDefault","stopPropagation","$this","clearTimeout","attr","ordersIds","reportSelectors","regions","report","check","parseInt","value","registerNormalCheckButton","window","location","href","url","interval","setInterval","clearInterval"],"mappings":";;;;;;;SA0BIA,WACAC,61BAEEC,oBACS,0CADTA,sBAKW,+EAQRC,YAAYC,gBACHC,cAAKC,KAAK,CAAC,CACrBC,WAAY,2BACZC,KAAM,CACFC,QAASL,YAGF,kBAQJM,aAAaC,cACpBC,IAAMC,MAAMC,QAAQH,UAAYA,SAAW,CAACA,UAC5CI,cAAgBH,IAAII,KAAIZ,UACjB,CACHG,WAAY,4BACZC,KAAM,CACFC,QAASL,aAIjBa,SAAWZ,cAAKC,KAAKS,eACrBG,WAAaC,QAAQC,IAAIH,UAEzBI,YAAc,UAClBH,KAAKI,SAAQ,CAACC,SAAUC,SACpBH,YAAYT,IAAIY,QAAUD,YAI9BE,QAAQC,UAAUL,aACXA,2BAMIM,oBAAoBhB,UAC/BA,SAAWE,MAAMC,QAAQH,UAAYA,SAAW,CAACA,cAC7CiB,QAAU,OACT,MAAMxB,WAAWO,SAClBiB,QAAQxB,UAAW,mBAAE,kDAAoDA,QAAU,MACnFwB,QAAQxB,SAASyB,KAAK,mBAGtBN,eAAiBb,aAAaC,cAE7B,MAAMP,WAAWO,SAAU,KAExBmB,YADQ,mBAAE,8CAAgD1B,QAAU,MAAM2B,OAAO,aAC9DC,QAAQ,MAAMC,KAAK,oCACtCV,SAASnB,SAAS8B,QAClBJ,WAAWK,KAAKZ,SAASnB,SAAS8B,QAGlCX,SAASnB,SAASgC,IAAK,KACnBC,aAAe,YAAcC,KAAKC,UAAUhB,SAASnB,SAAU,KAAM,MAAQ,YAC7EwB,QAAQxB,SAASoC,OACjBZ,QAAQxB,SAASyB,KAAKQ,mBACnB,GAAIP,WAAWU,OAAQ,KACtBC,WAAY,mBAAE,qDAAuDrC,QAAU,YACnF0B,WAAWY,OAAOD,WAClBA,UAAUZ,KAAKQ,cACfM,YAAW,WACPF,UAAUG,QAAQ,KAAK,+BACjBC,MAAMC,cAEb,wBAQJC,+BACE,mBAAE,qEACRC,GAAG,SAASC,eAAeC,GAC9BA,EAAEC,iBACFD,EAAEE,sBACEC,OAAQ,mBAAER,MACdS,aAAarD,iBACboD,MAAME,KAAK,YAAY,OAEnBnD,QAAUiD,MAAMnC,KAAK,WACrBd,eACMuB,oBAAoBvB,SAG9BH,gBAAkB0C,YAAW,WACzBU,MAAME,KAAK,YAAY,KACxB,SAGU,mBAAErD,qBACR8C,GAAG,SAASC,eAAeC,GAClCA,EAAEC,iBACFD,EAAEE,sBACEC,OAAQ,mBAAER,MACdS,aAAarD,iBACboD,MAAME,KAAK,YAAY,SAIjBC,UADiB,KADJ,mBAAEC,gBAAgBC,QAAQC,QACL1B,KAAK/B,wBACZc,KAAI4C,OAASC,SAASD,MAAME,eACvDnC,oBAAoB6B,WAE1BvD,gBAAkB0C,YAAW,WACzBU,MAAME,KAAK,YAAY,KACxB,uBAOIQ,0BAA0BtD,UACxB,mBAAE,sCACRuC,GAAG,SAASC,qBACXI,OAAQ,mBAAER,SAEVpC,QAAS,CACT6C,aAAarD,iBACboD,MAAME,KAAK,YAAY,SACjB7C,aAAaD,SAEK,mBADHN,YAAYM,UACpByB,OACT8B,OAAOC,SAASC,KAAOlE,WAEvBC,gBAAkB0C,YAAW,WACzBU,MAAME,KAAK,YAAY,KACxB,uBAMC,eAAC9C,+DAAU,KAAM0D,2DAAM,QAEnC1D,QAAS,CACTT,WAAamE,QACTC,SAAWC,aAAYpB,qBACnB1B,eAAiBpB,YAAYM,SACT,YAApBc,SAASW,QACToC,cAAcF,UACdJ,OAAOC,SAASC,KAAOlE,YACI,WAApBuB,SAASW,QAChBoC,cAAcF,8BAEhB,2BAA2BjC,KAAKZ,SAASW,UAC5C,MAGHzB,QACAsD,4BAEAhB"}