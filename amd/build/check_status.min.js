define("paygw_fawry/check_status",["exports","core/ajax","jquery","core_reportbuilder/local/selectors"],(function(_exports,_ajax,_jquery,reportSelectors){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module check_status
   *
   * @module     paygw_fawry/check_status
   * @copyright  2024 Mohammad Farouk <phun.for.physics@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */let successUrl,disabledTimeout;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_jquery=_interopRequireDefault(_jquery),reportSelectors=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(reportSelectors);const Selectors_bulkCheck='button[data-action="check-status-bulk"]',Selectors_checkedRows='[data-togglegroup="report-select-all"][data-toggle="slave"]:checked';function checkStatus(orderId){return _ajax.default.call([{methodname:"paygw_fawry_check_status",args:{orderid:orderId}}])[0]}async function instantCheck(orderIds){let ids=Array.isArray(orderIds)?orderIds:[orderIds],tobeRequested=ids.map((orderId=>({methodname:"paygw_fawry_instant_check",args:{orderid:orderId}}))),requests=_ajax.default.call(tobeRequested),data=await Promise.all(requests),indexedData={};return data.forEach(((response,index)=>{indexedData[ids[index]]=response})),console.log(await indexedData),indexedData}async function instanceCheckForIds(orderIds){orderIds=Array.isArray(orderIds)?orderIds:[orderIds];let holders={};for(const orderId of orderIds)holders[orderId]=(0,_jquery.default)('[data-purpose="status-response"][data-orderid="'+orderId+'"]'),holders[orderId].html("Checking...");let response=await instantCheck(orderIds);for(const orderId of orderIds){let statusCell=(0,_jquery.default)('[data-action="check-status"][data-orderid="'+orderId+'"]').filter("a, button").closest("tr").find('[data-purpose="order-status"]');if(response[orderId].status&&statusCell.text(response[orderId].status),response[orderId].msg){let responseHtml="<br><pre>"+JSON.stringify(response[orderId],null,"\t")+"</pre>";if(holders[orderId].length)holders[orderId].html(responseHtml);else if(statusCell.length){let newHolder=(0,_jquery.default)('<div data-purpose="status-response" data-orderid="'+orderId+'"></div>');statusCell.append(newHolder),newHolder.html(responseHtml),setTimeout((function(){newHolder.fadeOut(500,(function(){(0,_jquery.default)(this).remove()}))}),15e3)}}}}async function registerInstanceCheckButton(){(0,_jquery.default)('button[data-action="check-status"], a[data-action="check-status"]').on("click",(async function(e){e.preventDefault(),e.stopPropagation();let $this=(0,_jquery.default)(this);clearTimeout(disabledTimeout),$this.attr("disabled",!0);let orderId=$this.data("orderid");orderId&&await instanceCheckForIds(orderId),disabledTimeout=setTimeout((function(){$this.attr("disabled",!1)}),5e3)})),(0,_jquery.default)(Selectors_bulkCheck).on("click",(async function(e){e.preventDefault(),e.stopPropagation();let $this=(0,_jquery.default)(this);clearTimeout(disabledTimeout),$this.attr("disabled",!0);const ordersIds=[...(0,_jquery.default)(reportSelectors.regions.report).find(Selectors_checkedRows)].map((check=>parseInt(check.value)));await instanceCheckForIds(ordersIds),disabledTimeout=setTimeout((function(){$this.attr("disabled",!1)}),5e3)}))}async function registerNormalCheckButton(orderid){(0,_jquery.default)('button[data-action="check-status"]').on("click",(async function(){let $this=(0,_jquery.default)(this);if(orderid){clearTimeout(disabledTimeout),$this.attr("disabled",!0),await instantCheck(orderid),"success"===(await checkStatus(orderid)).status?window.location.href=successUrl:disabledTimeout=setTimeout((function(){$this.attr("disabled",!1)}),3e4)}}))}_exports.init=function(){let orderid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,url=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(orderid){successUrl=url;var interval=setInterval((async function(){let response=await checkStatus(orderid);"success"===response.status?(clearInterval(interval),window.location.href=successUrl):"failed"===response.status&&clearInterval(interval),(0,_jquery.default)('[data-purpose="status"]').text(response.status)}),15e3)}orderid?registerNormalCheckButton():registerInstanceCheckButton()}}));

//# sourceMappingURL=check_status.min.js.map